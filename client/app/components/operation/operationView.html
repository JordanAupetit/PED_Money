<div class="blocOperation">

  <div class="container">
    <!-- TODO -- Rajouter le SOLDE différé (Fonctionnel) -->
    
    <div ng-if="operations.length > 0">
      <strong>Balance : </strong>
      <span ng-if="balance <= 0" class="colorRed">
        {{ balance }}€
      </span>
      <span ng-if="balance > 0" class="colorGreen">
        +{{ balance }}€
      </span>
    </div>

    <div ng-if="operations.length > 0" class="mb20">
      <strong>Deferred balance : </strong>
      <span ng-if="deferredBalance <= 0" class="colorRed">
        {{ deferredBalance }}€
      </span>
      <span ng-if="deferredBalance > 0" class="colorGreen">
        +{{ deferredBalance }}€
      </span>
    </div>

    <a class="" ui-sref="optPeriod({accountId : accountId})">Operations périodiques</a>

    <div>
      <a class="" href="#/{{account._id}}/settings">Account settings</a>
    </div>
    
    <div>
        <select class="form-control wid200 ftl mr10" ng-change="groupOperation()" ng-model="groupedBy">
            <option value="">Not grouped</option>
            <option value="date">Grouped by Date</option>
            <option value="category">Grouped by Category</option>
            <option value="type">Grouped by Type</option>
            <option value="thirdParty">Grouped by Third Party</option>
        </select>

        <input ng-show="operations.length > 0 && groupOfOperations.length <= 0" ng-model="searchText" class="form-control wid150 ftl mr10" placeholder="Search">

        <select ng-show="operations.length > 0 && groupOfOperations.length <= 0" ng-model="orderProp" class="form-control wid200" ng-change="test()">
            <option value="value">Order by Price</option>
            <option value="dateOperation">Order by Date</option>
            <option value="categoryName">Order by Category</option>
            <option value="type">Order by Type</option>
        </select>
    </div>

    <div class="clear"></div>


            <!-- <div ng-if="op.showOps">
                <div class="operationLineOfGroup" ng-repeat="op in operationsOfGroup"> 
                    <div hover-operation ng-include="'/app/components/operation/operationLineTemplate.html'"></div>
                </div>
            </div> -->

    <label ng-if="groupOfOperations.length > 0" class="mt20">Operations grouped by {{ groupedBy }}</label>
    <div ng-repeat="op in groupOfOperations">
        <div ng-click="showOperationsOfGroup($index)" class="operationLine pointer">
            <div class="wid40p ftl">
                <span>Grouped by {{ groupedBy }} : '{{ op.groupedByField }}'</span>
            </div>

            <div class="wid50p ftl">
                <span>{{ op.subOperations.length }} operation(s) was/were grouped</span>
            </div>

        </div>

        <div ng-if="op.showOps">
            <div class="operationLineOfGroup" ng-repeat="op in operationsOfGroup">
                <div hover-operation ng-include="'/app/components/operation/operationLineTemplate.html'"></div>
            </div>
        </div>
    </div>

    <!-- <div ng-if="operationsOfGroup.length > 0">
      <label class="mt20">Operations of the selected group</label>
      
      <div class="operationLineOfGroup" ng-repeat="op in operationsOfGroup">
        <div hover-operation ng-include="'/app/components/operation/operationLineTemplate.html'"></div>
      </div>
    </div> -->

    <!-- <div ng-if="operations.length > 0 && groupOfOperations.length <= 0" class="mt20">
        <input ng-model="searchText" class="form-control wid150" placeholder="Search">
    
        <select ng-model="orderProp" class="form-control wid150">
          <option value="" disabled>Orber by</option>
          <option value="value">Price</option>
          <option value="dateOperation">Date</option>
          <option value="categoryName">category</option>
          <option value="type">type</option>
        </select>
    </div> -->

    <div ng-if="operations.length > 0 && groupOfOperations.length <= 0">

        <div ng-if="countOfOperationsAfterToday > 0">
            <label class="mt20">Deferred operations</label>
            <div ng-if="op.datePrelevementIsAfterToday" class="operationLine" ng-repeat="op in operations | filter:searchText | orderBy:orderProp"> 
                <div hover-operation ng-include="'/app/components/operation/operationLineTemplate.html'"></div>
            </div>
        </div>
        
        <div class="mt20">
            <label>Operations</label>
            <div ng-if="!op.datePrelevementIsAfterToday" class="operationLine" ng-repeat="op in operations | filter:searchText | orderBy:orderProp">
                <div hover-operation ng-include="'/app/components/operation/operationLineTemplate.html'"></div>
            </div>
        </div>
    </div>

    <div ng-if="operations.length <= 0 && groupOfOperations.length <= 0" class="mt20">
      Il n'y a encore aucunes opérations sur ce compte.
    </div>

  </div> <!-- END container -->

  <div ng-include src="'/app/shared/category/categoryView.html'"></div>
  <div btn-add-operation tooltip class="circle" data-toggle="modal" data-placement="left" title="Add operation" data-target=".modal-operation">
    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
  </div>

  <div id="sidebar-wrapper-right" class="menuSidebar">
    <form name="addOperationForm">
      <ul class="sidebar-nav">
        <li class="sidebar-brand">
          Add operation
        </li>
        <li>
          <label>Category</label>
          <div class="input-group">
            <select class="form-control " id="inputNewCategorySubCategory" ng-model="operationCreateModel.category" ng-options="categorie.name for categorie in categories track by categorie.id">
              <option value="" selected>No category</option>
            </select>
            <div class="input-group-btn">
              <button type="button" class="btn btn-default dropdown-toggle" aria-expanded="false" data-toggle="modal" data-backdrop="static" data-target="#modalManageCategories"><span class="glyphicon glyphicon-wrench"></span>
              </button>
            </div>
          </div>
        </li>
        <li>
          <label>Value<span class="colorRed">*</span></label>
          <div class="form-group" ng-class="{ 'has-error' : addOperationForm.value.$invalid && !addOperationForm.value.$pristine}">
            <input type="number" name="value" ng-model="operationCreateModel.value" class="form-control" placeholder="Value" required>
            <span class="error help-block" ng-show="addOperationForm.value.$error.required  && !addOperationForm.value.$pristine">
            Value is required</span>
            <span class="error help-block" ng-show="addOperationForm.value.$error.number">
            Not valid number</span>
          </div>
        </li>

        <span ng-if="operationCreateModel.advanced">
          <li>
            <label>Operation date</label>
            <input mydatepicker ng-model="operationCreateModel.dateOperation" class="form-control" placeholder="(Default today)">
          </li>
          
          <li>
            <label>Levy date</label>
            <input mydatepicker ng-model="operationCreateModel.datePrelevement" class="form-control" placeholder="(Default operation date)">
          </li>
          <li>
            <label>Description</label>
            <input type="text" ng-model="operationCreateModel.description" class="form-control" placeholder="Description">
          </li>
          <li>
            <label>Third party</label>
            <input type="text" ng-model="operationCreateModel.thirdParty" class="form-control" placeholder="Third party">
          </li>
          <li>
            <label>Type</label>
            <input type="text" ng-model="operationCreateModel.type" class="form-control" placeholder="Type">
          </li>
          <li>
            <button type="button" button-checkbox class="btn btn-default">
            <input ng-model="operationCreateModel.periodic" type="checkbox">
            Periodic
            </button>
          </li>

          <span ng-if="operationCreateModel.periodic">
            <li class="form-group">
              <label>Period of repetition </label>
              <select name="intervalType" class="form-control" ng-model="operationCreateModel.period.intervalType" ng-options="interval as interval.type for interval in intervalType" required>
              </select>
            </li>
            <li class="form-group" ng-class="{ 'has-error' : addOperationForm.periodStep.$invalid && !addOperationForm.periodStep.$pristine }">
              <label>Period step<span class="colorRed">*</span></label>
              <input type="number" class="form-control" name="periodStep" ng-model="operationCreateModel.period.step" min="1" required>
              <p ng-show="addOperationForm.periodStep.$error.required && !addOperationForm.periodStep.$pristine" class="help-block">Period step is required.</p>
              <p class="error help-block" ng-show="addOperationForm.periodStep.$error.number">
              Must be a valid number.</p>
              <p ng-show="addOperationForm.periodStep.$error.min" class="help-block">Must be superior of 0.</p>
            </li>
            <li class="form-group">
              <label>Begin date of repetition</label>
              <input mydatepicker ng-model="operationCreateModel.period.dateBegin" class="form-control" placeholder="(Default today)">
            </li>
            <li class="form-group">
              <button type="button" button-checkbox class="btn btn-default">
              <input ng-model="operationCreateModel.period.infinite" type="checkbox"> Infinite
              </button>
            </li>
            <li ng-if="!operationCreateModel.period.infinite">
              <!-- TODO: Verifier que la date est bien incluse dans occurency -->
              <label>Occurency (begin date included) <span class="colorRed">*</span></label>
              <div class="form-group" ng-class="{ 'has-error' : addOperationForm.occurency.$invalid  && !addOperationForm.occurency.$pristine }">
                <input type="number" name="occurency" ng-model="operationCreateModel.period.occurency" class="form-control" min="2" required>
                <span class="error help-block" ng-show="addOperationForm.occurency.$error.required && !addOperationForm.occurency.$pristine">
                Occurency is required</span>
                <span class="error help-block" ng-show="addOperationForm.occurency.$error.number">
                Must be a valid number</span>
                <span class="error help-block" ng-show="addOperationForm.occurency.$error.min">
                Must be more than 2</span>
              </div>
            </li>
          </span> <!-- END operationCreateModel.periodic -->

        </span> <!-- END operationCreateModel.advanced -->
        <li>
          <button close-menu-create-operation ng-disabled="addOperationForm.$invalid" ng-click="addOperation()" class="btn btn-primary">Add</button>
          <button type="button" ng-if="!operationCreateModel.advanced" ng-click="showOperationAdvanced()" class="btn btn-default">Advanced</button>
          <button type="button" ng-if="operationCreateModel.advanced" ng-click="hideOperationAdvanced()" class="btn btn-default">Simple</button>
          <!-- TODO: Ameliorer en mettant une croix en haut -->
          <button type="button" close-menu-create-operation class="btn btn-default">Close</button>
        </li>
      </ul>
    </form>
  </div> <!-- END sidebar-wrapper-right -->

</div> <!-- END blocOperation -->
