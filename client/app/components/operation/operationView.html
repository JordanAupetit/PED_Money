<div class="blocOperation pt70">

    <div class="container">
        <div ng-show="ventilateOperation === null">
            <div ng-if="operations.length > 0" class="fs20">
                <strong>Balance : </strong>
                <span ng-if="balance <= 0" class="colorRed">
                    {{ balance }}€
                </span>
                <span ng-if="balance > 0" class="colorGreen">
                    +{{ balance }}€
                </span>
            </div>

            <div ng-if="operations.length > 0" class="mb20 fs12">
                <strong>Deferred balance : </strong>
                <span ng-if="deferredBalance <= 0" class="colorRed">
                    {{ deferredBalance }}€
                </span>
                <span ng-if="deferredBalance > 0" class="colorGreen">
                    +{{ deferredBalance }}€
                </span>
                <button ng-show="showDeferredOps" ng-click="toggleDeferredOps()" class="btn btn-default btn-xs">Hide</button>
                <button ng-show="!showDeferredOps" ng-click="toggleDeferredOps()" class="btn btn-default btn-xs">Show</button>
            </div>

            <div class="mt10">
                <a class="btn btn-default" ui-sref="optPeriod({accountId : accountId})">Periodics operations</a>
            </div>

            <div class="mt10">
                <a class="btn btn-default" href="#/{{accountId}}/settings">Account settings</a>
            </div>
            
            <div ng-show="operations.length > 0" class="mt10">
                <a class="btn btn-default" href="/api/account/{{accountId}}/pdf" target="_blank">Export to PDF</a>
            </div>

            <div ng-show="operations.length > 0" class="mt10">
                <a download="operations.csv" ng-href="{{ urlCsv }}" class="btn btn-default">Export to CSV</a>
            </div>

            <div ng-show="operations.length > 0" class="mt10">
                <form class="importCsv">
                    <div class="wid300 ftl">
                        <input type="file" on-read-file="importCsv($fileContent)" class="filestyle">
                    </div>
                    <button ng-click="addOperationsFromCsv()" button-import-csv-to-app ng-disabled="importButtonTitle === 'No operations to import'" type="button" class="btn btn-default ml10">{{ importButtonTitle }}</button>
                    <div class="clear"></div>
                </form>
            </div>

            <div ng-show="operations.length > 0" class="row">
                <div class="col-md-4 col-xs-12 mt10">
                    <select class="form-control " ng-change="groupOperation()" ng-model="groupedBy">
                        <option value="">Not grouped</option>
                        <option value="date">Grouped by Date</option>
                        <option value="category">Grouped by Category</option>
                        <option value="type">Grouped by Type</option>
                        <option value="thirdParty">Grouped by Third Party</option>
                    </select>
                </div>
                
                <div class="col-md-4 col-xs-12 mt10">
                  <input ng-show="operations.length > 0 && groupOfOperations.length <= 0" ng-model="searchText" class="form-control" placeholder="Search">
                </div>

                <div class="col-md-4 col-xs-12 mt10">
                  <select ng-show="operations.length > 0 && groupOfOperations.length <= 0" ng-model="orderProp" class="form-control" ng-change="test()">
                      <option value="value">Order by Price</option>
                      <option value="dateOperation">Order by Date</option>
                      <option value="categoryName">Order by Category</option>
                      <option value="type">Order by Type</option>
                  </select>
                </div>
            </div>

            <div class="clear"></div>


                    <!-- <div ng-if="op.showOps">
                        <div class="operationLineOfGroup" ng-repeat="op in operationsOfGroup"> 
                            <div click-operation ng-include="'/app/components/operation/operationLineTemplate.html'"></div>
                        </div>
                    </div> -->

            <label ng-if="groupOfOperations.length > 0" class="mt20">Operations grouped by {{ groupedBy }}</label>
            <div ng-repeat="op in groupOfOperations">
                <div ng-click="toggleOperationsOfGroup($index, op.showOps)" class="operationGroupOfLine operationLine pointer backWhite pad15">

                  <!-- Plus grand qu'un Mobile -->
                  <div class="hidden-xs">
                    <div class="wid40p ftl">
                        <span>Grouped by {{ groupedBy }} : '{{ op.groupedByField }}'</span>
                    </div>

                    <div class="wid50p ftl">
                        <span>{{ op.subOperations.length }} operation(s) was/were grouped</span>
                    </div>

                    <div class="wid10p ftl algright">
                        <span ng-if="op.value <= 0" class="colorRed">
                            {{ op.value }}
                        </span>
                        <span ng-if="op.value > 0" class="colorGreen">
                            +{{ op.value }}
                        </span>
                    </div>
                  </div>

                  <!-- Taille d'un Mobile -->
                  <div class="visible-xs-block">
                    <div class="wid70p ftl">
                        <span>'{{ op.groupedByField }}'</span>
                    </div>

                    <div class="wid30p ftl algright">
                        <span ng-if="op.value <= 0" class="colorRed">
                            {{ op.value }}
                        </span>
                        <span ng-if="op.value > 0" class="colorGreen">
                            +{{ op.value }}
                        </span>
                    </div>
                  </div>
                </div>

                <div ng-if="op.showOps">
                    <div class="operationLine operationLineOfGroup" ng-repeat="op in operationsOfGroup">
                        <div click-operation ng-include="'/app/components/operation/operationLineTemplate.html'"></div>
                    </div>

                </div>
            </div>


            <div ng-if="operations.length > 0 && groupOfOperations.length <= 0">

                <div ng-if="countOfOperationsAfterToday > 0 && showDeferredOps">
                    <label class="mt20">Deferred operations</label>
                    <div ng-include="'/app/components/operation/operationDescriptionTemplate.html'"></div>
                    <div ng-if="op.datePrelevementIsAfterToday" class="operationLine backWhite" ng-repeat="op in operations | filter:searchText | orderBy:orderProp"> 
                        <div click-operation ng-include="'/app/components/operation/operationLineTemplate.html'"></div>
                    </div>
                </div>
                
                <div ng-if="countOfOperationsNotAfterToday > 0" class="mt20">
                    <label>Operations</label>
                    <div ng-include="'/app/components/operation/operationDescriptionTemplate.html'"></div>
                    <div ng-if="!op.datePrelevementIsAfterToday" class="operationLine backWhite" ng-repeat="op in operations | filter:searchText | orderBy:orderProp">
                        <div click-operation ng-include="'/app/components/operation/operationLineTemplate.html'"></div>
                    </div>

                </div>
            </div>

            <div ng-if="operations.length <= 0 && groupOfOperations.length <= 0" class="mt20">
                There are yet no operations on this account.
            </div>
        </div>

        <div ng-show="ventilateOperation !== null">
            <div class="fs20">
                <strong>Balance to assign: </strong>
                <span ng-if="balanceToAssign <= 0" class="colorRed">
                    {{ balanceToAssign }}€
                </span>
                <span ng-if="balanceToAssign > 0" class="colorGreen">
                    +{{ balanceToAssign }}€
                </span>
            </div>
            
            <form name="formSubOperation">
                <div class="col-md-5 col-xs-12 mt10">
                    <!-- <input ng-model="subOperationModel.description" type="text" class="form-control" placeholder="Description" required> -->
                    <div class="form-group" ng-class="{ 'has-error' : formSubOperation.description.$invalid && !formSubOperation.description.$pristine}">
                        <input type="text" name="description" ng-model="subOperationModel.description" class="form-control" placeholder="Description" required>
                        <span class="error help-block" ng-show="formSubOperation.description.$error.required  && !formSubOperation.description.$pristine">
                        Description is required</span>
                    </div>
                </div>

                <div class="col-md-5 col-xs-12 mt10">
                    <!-- <input ng-model="subOperationModel.value" type="number" class="form-control" placeholder="Value" required> -->
                    <div class="form-group" ng-class="{ 'has-error' : formSubOperation.value.$invalid && !formSubOperation.value.$pristine}">
                        <input type="number" name="value" ng-model="subOperationModel.value" class="form-control" placeholder="Value" required>
                        <span class="error help-block" ng-show="formSubOperation.value.$error.required  && !formSubOperation.value.$pristine">
                        Value is required</span>
                        <span class="error help-block" ng-show="formSubOperation.value.$error.number">
                        Not valid number</span>
                    </div>
                </div>

                <div class="col-md-2 col-xs-12 mt10">
                    <button ng-disabled="formSubOperation.$invalid" ng-click="addSubOperation()" class="btn btn-default">Add suboperation</button>
                </div>
            </form>

            <div class="clear mb20"></div>

            <div ng-repeat="op in ventilateOperation.subOperations" class="ventilationLine backWhite pad15">
                <div class="wid70p">
                    {{ op.description }}
                </div>

                <div class="wid30p algright ventilationRightZone">
                    <span ng-if="op.value <= 0" class="colorRed">
                        {{ op.value }}
                    </span>
                    <span ng-if="op.value > 0" class="colorGreen">
                        +{{ op.value }}
                    </span>
                    <button ng-click="deleteSubOperation(op, $index)" class="btn btn-danger btn-xs">
                        <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                    </button>
                </div>

                <!-- <div class="wid10p ftl algright">
                    <button ng-click="deleteSubOperation($index)" class="btn btn-danger btn-xs">
                        <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                    </button>
                </div> -->
            </div>

            <button ng-click="hideVentilation()" class="btn btn-default mt10">Back</button>
            <button ng-disabled="balanceToAssign !== 0" ng-click="saveVentilation()" class="btn btn-primary mt10">Save the ventilation</button> <br>
            <div class="mt10">You must assign the entire balance to validate ventilation.</div>
        </div>
    </div> <!-- END container -->

  <div ng-include src="'/app/shared/category/categoryView.html'"></div>
  <div btn-add-operation tooltip class="circle" data-toggle="modal" data-placement="left" title="Add operation" data-target=".modal-operation">
    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
  </div>

  <div id="sidebar-wrapper-right" class="menuSidebar">
    <form name="addOperationForm">
      <ul class="sidebar-nav">
        <li class="sidebar-brand">
          Add operation
        </li>
        <li>
          <label>Category</label>
          <!-- <div class="input-group"> -->
            <select class="form-control " id="inputNewCategorySubCategory" ng-model="operationCreateModel.category" ng-options="categorie.name for categorie in categoriesSelect track by categorie.id">
              <option value="" selected>No category</option>
            </select>
            <!--             <div class="input-group-btn">
              <button type="button" class="btn btn-default dropdown-toggle" aria-expanded="false" data-toggle="modal" data-backdrop="static" data-target="#modalManageCategories"><span class="glyphicon glyphicon-wrench"></span>
              </button>
            </div> -->
          <!-- </div> -->
        </li>
        <li>
          <label>Value<span class="colorRed">*</span></label>
          <div class="form-group" ng-class="{ 'has-error' : addOperationForm.value.$invalid && !addOperationForm.value.$pristine}">
            <input type="number" name="value" ng-model="operationCreateModel.value" class="form-control" placeholder="Value" required>
            <span class="error help-block" ng-show="addOperationForm.value.$error.required  && !addOperationForm.value.$pristine">
            Value is required</span>
            <span class="error help-block" ng-show="addOperationForm.value.$error.number">
            Not valid number</span>
          </div>
        </li>

        <span ng-if="operationCreateModel.advanced">
          <li>
            <label>Operation date</label>
            <input mydatepicker ng-model="operationCreateModel.dateOperation" class="form-control" placeholder="(Default today)">
          </li>
          
          <li>
            <label>Levy date</label>
            <input mydatepicker ng-model="operationCreateModel.datePrelevement" class="form-control" placeholder="(Default operation date)">
          </li>
          <li>
            <label>Description</label>
            <input type="text" ng-model="operationCreateModel.description" class="form-control" placeholder="Description">
          </li>
          <li>
            <label>Third party</label>
            <input type="text" ng-model="operationCreateModel.thirdParty" class="form-control" placeholder="Third party">
          </li>
          <li>
            <label>Type</label>
            <!-- <input type="text" ng-model="operationCreateModel.type" class="form-control" placeholder="Type"> -->
            <select class="form-control" ng-model="operationCreateModel.type">
                <option value="" selected disabled>Select a type</option>
                <option value="credit card">Credit card</option>
                <option value="transfer">Transfer</option>
                <option value="check">Check</option>
                <option value="cash">Cash</option>
                <option value="other type">Other type</option>
            </select>
          </li>
          <li>
            <!-- <button type="button" button-checkbox class="btn btn-default"> -->
            <input ng-model="operationCreateModel.periodic" type="checkbox">
            Periodic
            <!-- </button> -->
          </li>

          <span ng-if="operationCreateModel.periodic">
            <li class="form-group">
              <label>Period of repetition </label>
              <select name="intervalType" class="form-control" ng-model="operationCreateModel.period.intervalType" ng-options="interval as interval.type for interval in intervalType" required>
              </select>
            </li>
            <li class="form-group" ng-class="{ 'has-error' : addOperationForm.periodStep.$invalid && !addOperationForm.periodStep.$pristine }">
              <label>Period step<span class="colorRed">*</span></label>
              <input type="number" class="form-control" name="periodStep" ng-model="operationCreateModel.period.step" min="1" required>
              <p ng-show="addOperationForm.periodStep.$error.required && !addOperationForm.periodStep.$pristine" class="help-block">Period step is required.</p>
              <p class="error help-block" ng-show="addOperationForm.periodStep.$error.number">
              Must be a valid number.</p>
              <p ng-show="addOperationForm.periodStep.$error.min" class="help-block">Must be superior of 0.</p>
            </li>
            <li class="form-group">
              <label>Begin date of repetition</label>
              <input mydatepicker ng-model="operationCreateModel.period.dateBegin" class="form-control" placeholder="(Default today)">
            </li>
            <li class="form-group">
              <button type="button" button-checkbox class="btn btn-default">
              <input ng-model="operationCreateModel.period.infinite" type="checkbox"> Infinite
              </button>
            </li>
            <li ng-if="!operationCreateModel.period.infinite">
              <!-- TODO: Verifier que la date est bien incluse dans occurency -->
              <label>Occurency (begin date included) <span class="colorRed">*</span></label>
              <div class="form-group" ng-class="{ 'has-error' : addOperationForm.occurency.$invalid  && !addOperationForm.occurency.$pristine }">
                <input type="number" name="occurency" ng-model="operationCreateModel.period.occurency" class="form-control" min="2" required>
                <span class="error help-block" ng-show="addOperationForm.occurency.$error.required && !addOperationForm.occurency.$pristine">
                Occurency is required</span>
                <span class="error help-block" ng-show="addOperationForm.occurency.$error.number">
                Must be a valid number</span>
                <span class="error help-block" ng-show="addOperationForm.occurency.$error.min">
                Must be more than 2</span>
              </div>
            </li>
          </span> <!-- END operationCreateModel.periodic -->

        </span> <!-- END operationCreateModel.advanced -->
        <li>
          <button close-menu-create-operation ng-disabled="addOperationForm.$invalid" ng-click="addOperation()" class="btn btn-primary">Add</button>
          <button type="button" ng-if="!operationCreateModel.advanced" ng-click="showOperationAdvanced()" class="btn btn-default">Advanced</button>
          <button type="button" ng-if="operationCreateModel.advanced" ng-click="hideOperationAdvanced()" class="btn btn-default">Simple</button>
          <!-- TODO: Ameliorer en mettant une croix en haut -->
          <button type="button" close-menu-create-operation class="btn btn-default">Close</button>
        </li>
      </ul>
    </form>
  </div> <!-- END sidebar-wrapper-right -->

</div> <!-- END blocOperation -->
